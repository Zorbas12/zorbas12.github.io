<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<!-- Favicon -->
<link rel="icon" type="image/png" href="https://www.zorbas.com.cy/wp-content/uploads/cropped-zorbas-favicon-01-270x270.png">

<!-- Page title (what appears on the tab) -->
<title>Zorbas</title>
<style>
@import url('https://fonts.cdnfonts.com/css/algerian');

@keyframes fadeOut {
  from { opacity: 1; transform: translateY(0); }
  to { opacity: 0; transform: translateY(-20px); }
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-20px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes slideInRight {
  from { opacity: 0; transform: translateX(30px); }
  to { opacity: 1; transform: translateX(0); }
}

@keyframes slideInLeft {
  from { opacity: 0; transform: translateX(-30px); }
  to { opacity: 1; transform: translateX(0); }
}

@keyframes scaleIn {
  from { opacity: 0; transform: scale(0.8); }
  to { opacity: 1; transform: scale(1); }
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.05); }
}

@keyframes shimmer {
  0% { background-position: -1000px 0; }
  100% { background-position: 1000px 0; }
}

@keyframes slideInFromRight {
  from { transform: translateX(100%); }
  to { transform: translateX(0); }
}

body {
  font-family: Arial, sans-serif;
  background: linear-gradient(135deg, #DAD9D7 0%, #c5c4c2 100%);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  min-height: 100vh;
  margin: 0;
  padding-top: 50px;
  position: relative;
}

.lang-buttons { 
    position: fixed; 
    top: 15px; 
    right: 15px; 
    font-size: 14px;
    animation: slideInRight 0.6s ease;
    z-index: 10001;
}
.lang-buttons button { 
    background-color: #DAD9D7; 
    border: none; 
    cursor: pointer; 
    margin: 0 2px; 
    font-size: 14px; 
    font-weight: normal;
    transition: all 0.3s ease;
    padding: 5px 10px;
    border-radius: 4px;
}
.lang-buttons button:hover {
    transform: translateY(-2px);
    background-color: #E8DA89;
}
.lang-buttons button.active { 
    font-weight: bold;
    background-color: #E8DA89;
}

.form-title { 
    font-family: 'Algerian', sans-serif; 
    font-size: 60px; 
    font-weight: bold; 
    margin-bottom: 10px; 
    text-align: center;
    animation: fadeIn 0.8s ease;
    background: linear-gradient(90deg, #333, #666, #333);
    background-size: 200% auto;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: shimmer 3s linear infinite, fadeIn 0.8s ease;
}

.form-box { 
    background: #fff; 
    padding: 30px 40px; 
    border-radius: 14px; 
    box-shadow: 0 8px 24px rgba(0,0,0,0.15); 
    width: 320px; 
    text-align: center; 
    margin-bottom: 20px;
    animation: scaleIn 0.6s ease;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.form-box:hover {
    transform: translateY(-5px);
    box-shadow: 0 12px 32px rgba(0,0,0,0.2);
}

label { 
    display: block; 
    margin-bottom: 6px; 
    font-weight: bold; 
    text-align: center;
    animation: fadeIn 0.5s ease;
}

input, select { 
    width: 90%; 
    padding: 10px; 
    margin-bottom: 18px; 
    border: 1px solid #ccc; 
    border-radius: 6px; 
    text-align: left; 
    font-size: 14px; 
    box-sizing: border-box;
    transition: all 0.3s ease;
}

input:focus, select:focus {
    outline: none;
    border-color: #E8DA89;
    box-shadow: 0 0 0 3px rgba(232, 218, 137, 0.2);
    transform: scale(1.02);
}

#store-container { 
    max-height: 0; 
    overflow: hidden; 
    transition: max-height 0.5s ease; 
}
#store-container.show { 
    max-height: 500px; 
}

.submit-btn { 
    background-color: #E8DA89; 
    border: none; 
    padding: 12px 20px; 
    border-radius: 6px; 
    font-size: 16px; 
    cursor: pointer; 
    font-weight: bold;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}
.submit-btn::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.5);
    transform: translate(-50%, -50%);
    transition: width 0.6s, height 0.6s;
}
.submit-btn:hover::before {
    width: 300px;
    height: 300px;
}
.submit-btn:hover { 
    background-color: #d4c15e;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}
.submit-btn:active {
    transform: translateY(0);
}

#message { 
    margin-top: 10px; 
    padding: 10px 15px; 
    border-radius: 6px; 
    color: #fff; 
    font-weight: bold; 
    display: none; 
    font-size: 14px;
    animation: fadeIn 0.3s ease;
}

#admin-gui, #locations-gui, #schedule-gui, .store-gui, #devices-gui, #history-gui {
    display: none;
    position: fixed;
    top:0; left:0; width:100%; height:100%;
    background-color: #DAD9D7;
    z-index: 9999;
    justify-content:center;
    align-items:center;
    flex-direction: column;
    animation: fadeIn 0.4s ease;
}

#admin-gui button, #locations-gui button, #schedule-gui button, .store-gui button {
    background-color: #E8DA89; 
    border: none;
    padding: 12px 20px;
    border-radius: 6px;
    font-size: 18px;
    margin: 10px;
    font-weight: bold;
    cursor: pointer;
    text-align: center;
    transition: all 0.3s ease;
    animation: scaleIn 0.4s ease forwards;
    opacity: 0;
}

#admin-gui button:nth-child(1) { animation-delay: 0.1s; }
#admin-gui button:nth-child(2) { animation-delay: 0.2s; }
#admin-gui button:nth-child(3) { animation-delay: 0.3s; }
#admin-gui button:nth-child(4) { animation-delay: 0.4s; }

#locations-gui button:nth-child(1) { animation-delay: 0.1s; }
#locations-gui button:nth-child(2) { animation-delay: 0.15s; }
#locations-gui button:nth-child(3) { animation-delay: 0.2s; }
#locations-gui button:nth-child(4) { animation-delay: 0.25s; }
#locations-gui button:nth-child(5) { animation-delay: 0.3s; }
#locations-gui button:nth-child(6) { animation-delay: 0.35s; }

#admin-gui button:hover, #locations-gui button:hover, #schedule-gui button:hover, .store-gui button:hover {
    background-color: #d4c15e;
    transform: translateY(-3px) scale(1.05);
    box-shadow: 0 6px 16px rgba(0,0,0,0.2);
}

#admin-gui #back-admin, #locations-gui #back-locations, #schedule-gui #back-schedule, .store-gui .back-store-btn { 
    background-color: #ff4c4c; 
    color: #fff; 
}
#admin-gui #back-admin:hover, #locations-gui #back-locations:hover, #schedule-gui #back-schedule:hover, .store-gui .back-store-btn:hover { 
    background-color: #e03b3b; 
}

#admin-btn, #schedule-btn, #history-btn {
    display: block;
    margin: 10px auto 0;
    background-color: #E8DA89;
    border: none;
    padding: 12px 20px;
    border-radius: 6px;
    font-size: 18px;
    font-weight: bold;
    cursor: pointer;
    text-align: center;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

#admin-btn:hover, #schedule-btn:hover, #history-btn:hover {
    background-color: #d4c15e;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

#locations-gui button, #schedule-gui button {
    width: 200px;
}

.store-gui button {
    width: 200px;
}

#store-buttons-container, #store-buttons-container-schedule {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
}

#devices-gui {
    justify-content:flex-start;
    padding:20px;
    overflow-y:auto;
}

.submission-card {
    animation: slideInLeft 0.4s ease;
}

@keyframes popIn {
  0% { transform: scale(0); opacity: 0; }
  50% { transform: scale(1.1); }
  100% { transform: scale(1); opacity: 1; }
}

.popup-notification {
    animation: popIn 0.4s ease;
}

#schedule-edit-table td {
    transition: all 0.3s ease;
}

.toolbar-sidebar {
  position: fixed;
  top: 0;
  left: -320px;
  width: 280px;
  height: 100%;
  background: linear-gradient(180deg, #fff 0%, #f8f8f8 100%);
  box-shadow: 4px 0 20px rgba(0,0,0,0.15);
  z-index: 10002;
  transition: left 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  overflow-y: auto;
  padding: 20px;
}

.toolbar-sidebar.open {
  left: 0;
}

.toolbar-section {
  margin-bottom: 25px;
}

.toolbar-section-title {
  font-size: 12px;
  font-weight: bold;
  color: #666;
  margin-bottom: 10px;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.toolbar-button {
  width: 100%;
  padding: 14px 16px;
  margin: 6px 0;
  background: #fff;
  border: 2px solid #E8DA89;
  border-radius: 8px;
  cursor: pointer;
  font-size: 15px;
  font-weight: 600;
  transition: all 0.3s ease;
  text-align: left;
  display: flex;
  align-items: center;
  gap: 12px;
  color: #333;
}

.toolbar-button:hover {
  background: #E8DA89;
  transform: translateX(5px);
  box-shadow: 0 4px 12px rgba(232, 218, 137, 0.4);
}

.toolbar-button:active {
  transform: translateX(3px);
}

.toolbar-button-icon {
  font-size: 18px;
  width: 24px;
  text-align: center;
}

.toolbar-toggle {
  position: fixed;
  top: 20px;
  left: 20px;
  width: 52px;
  height: 52px;
  background: #E8DA89;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  display: none;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  gap: 5px;
  z-index: 10003;
  transition: all 0.3s ease;
  box-shadow: 0 4px 16px rgba(0,0,0,0.2);
}

.toolbar-toggle:hover {
  background: #d4c15e;
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(0,0,0,0.25);
}

.toolbar-toggle:active {
  transform: translateY(0);
}

.toolbar-toggle span {
  width: 28px;
  height: 3px;
  background: #333;
  border-radius: 3px;
  transition: all 0.3s ease;
}

.toolbar-sidebar-header {
  position: fixed;
  top: 0;
  left: 0;
  width: 280px;
  background: #E8DA89;
  padding: 18px 20px;
  font-size: 20px;
  font-weight: bold;
  color: #333;
  z-index: 10004;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  display: none;
}

.toolbar-close {
  position: absolute;
  top: 20px;
  right: 20px;
  background: #ff4c4c;
  color: white;
  border: none;
  width: 36px;
  height: 36px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 20px;
  font-weight: bold;
  transition: all 0.3s ease;
  z-index: 10005;
  display: flex;
  align-items: center;
  justify-content: center;
}

.toolbar-close:hover {
  background: #e03b3b;
  transform: scale(1.1);
}

.toolbar-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  z-index: 10001;
  display: none;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.toolbar-overlay.show {
  display: block;
  opacity: 1;
}

.print-schedule-btn {
  position: fixed;
  top: 20px;
  right: 20px;
  background: #E8DA89;
  color: #000;
  border: none;
  padding: 10px 20px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: bold;
  display: none;
  z-index: 10000;
  transition: all 0.3s ease;
  font-size: 14px;
}

.print-schedule-btn:hover {
  background: #d4c15e;
  transform: translateY(-2px);
}

.history-card {
  background: #fff;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  width: 90%;
  max-width: 600px;
  animation: slideInLeft 0.4s ease;
  margin: 10px 0;
}

.history-status {
  display: inline-block;
  padding: 5px 15px;
  border-radius: 20px;
  font-weight: bold;
  font-size: 12px;
  margin-top: 10px;
}

.history-status.pending {
  background: #FFC107;
  color: #000;
}

.history-status.accepted {
  background: #4CAF50;
  color: #fff;
}

.history-status.declined {
  background: #F44336;
  color: #fff;
}

#history-gui {
  overflow-y: auto;
  padding: 20px;
}

@media print {
  body * { visibility: hidden; }
  #schedule-edit-table, #schedule-edit-table * { visibility: visible; }
  #schedule-edit-table { 
    position: absolute; 
    left: 0; 
    top: 0; 
    width: 100%;
  }
  #edit-schedule-btn, #back-schedule, .toolbar-toggle, .toolbar-sidebar, .print-schedule-btn { display: none !important; }
}

</style>
</head>
<body>
<div class="lang-buttons">
  <button id="greek-btn">ŒïŒõŒõ</button> / 
  <button id="eng-btn" class="active">ENG</button>
</div>

<div class="form-title" id="form-title">Zorbas12</div>

<div class="form-box" id="submit-gui">
  <form id="zorbas-form">
    <label for="name" id="label-name">Name</label>
    <input type="text" id="name" placeholder="Fill out your name" required>

    <label for="month" id="label-month">Month</label>
    <select id="month" required>
      <option value="" disabled selected>Select month</option>
      <option>January</option><option>February</option><option>March</option>
      <option>April</option><option>May</option><option>June</option>
      <option>July</option><option>August</option><option>September</option>
      <option>October</option><option>November</option><option>December</option>
    </select>

    <label for="day" id="label-day">Day</label>
    <input type="text" id="day" placeholder="Fill out your day" pattern="[0-9\s-]+" required>

    <label for="shift" id="label-shift">Shift</label>
    <select id="shift" required>
      <option value="" disabled selected>Select shift</option>
      <option>off</option>
      <option>6-2</option>
      <option>2-10</option>
    </select>

    <label for="location" id="label-location">Location</label>
    <select id="location" required>
      <option value="" disabled selected>Select location</option>
      <option value="NICOSIA">Nicosia</option>
      <option value="LARNACA">Larnaca</option>
      <option value="FAMAGUSTA">Famagusta</option>
      <option value="LIMASSOL">Limassol</option>
      <option value="PAFOS">Pafos</option>
    </select>

    <div id="store-container">
      <label for="store" id="label-store">Store</label>
      <select id="store"></select>
    </div>

    <button type="button" class="submit-btn" id="submit-btn">Submit</button>
    <div id="message"></div>
  </form>

  <button type="button" class="submit-btn" id="history-btn" style="margin-top:10px;">My History</button>
  <button type="button" class="submit-btn" id="schedule-btn" style="margin-top:10px;">Schedule GUI</button>
  <button type="button" class="submit-btn" id="admin-btn" style="margin-top:10px;">Admin GUI</button>
</div>

<div id="admin-gui">
    <button id="see-submissions">See all submissions</button>
    <button id="reset-submissions">Reset all submissions</button>
    <button id="see-users">See all users</button>
    <button id="back-admin">Back</button>
</div>

<div id="locations-gui">
    <button class="location-btn" data-loc="NICOSIA">Nicosia</button>
    <button class="location-btn" data-loc="LARNACA">Larnaca</button>
    <button class="location-btn" data-loc="FAMAGUSTA">Famagusta</button>
    <button class="location-btn" data-loc="LIMASSOL">Limassol</button>
    <button class="location-btn" data-loc="PAFOS">Pafos</button>
    <button id="back-locations">Back</button>
</div>

<div id="schedule-gui">
    <button class="schedule-location-btn" data-loc="NICOSIA">Nicosia</button>
    <button class="schedule-location-btn" data-loc="LARNACA">Larnaca</button>
    <button class="schedule-location-btn" data-loc="FAMAGUSTA">Famagusta</button>
    <button class="schedule-location-btn" data-loc="LIMASSOL">Limassol</button>
    <button class="schedule-location-btn" data-loc="PAFOS">Pafos</button>
    <button id="back-schedule">Back</button>
</div>

<div class="store-gui" id="store-gui">
    <div id="store-buttons-container"></div>
    <button class="back-store-btn" id="back-store">Back</button>
</div>

<div class="store-gui" id="store-gui-schedule">
    <div id="store-buttons-container-schedule"></div>
    <button class="back-store-btn" id="back-store-schedule">Back</button>
</div>

<div id="devices-gui">
    <h2 style="text-align:center;margin-bottom:20px;">Devices</h2>
    <div id="devices-container" style="width:100%; max-width:600px; display:flex; flex-direction:column; align-items:center; gap:10px;"></div>
    <button id="back-devices" style="background-color:#ff4c4c;color:#fff;padding:12px 20px;border:none;border-radius:6px;font-size:16px;font-weight:bold;cursor:pointer;margin-top:20px;">Back</button>
</div>

<div id="history-gui">
  <h2 style="text-align:center;margin-bottom:20px;font-size:32px;">My Submission History</h2>
  <div id="history-container" style="width:100%; max-width:800px; margin:0 auto; display:flex; flex-direction:column; align-items:center; gap:15px;"></div>
  <button id="back-history" style="background-color:#ff4c4c;color:#fff;padding:12px 20px;border:none;border-radius:6px;font-size:16px;font-weight:bold;cursor:pointer;margin:30px auto;display:block;">Back</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getDatabase, ref, push, onValue, remove, set, get, update } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyB08KDzXF6rgvqPJGaaD1SYPycAecaH8Vg",
  authDomain: "zorbas1.firebaseapp.com",
  databaseURL: "https://zorbas1-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "zorbas1",
  storageBucket: "zorbas1.firebasestorage.app",
  messagingSenderId: "26818695331",
  appId: "1:26818695331:web:afafafe4454bacf5d3af16",
  measurementId: "G-WHH6ZTZNP0"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

function getDeviceType() {
  const ua = navigator.userAgent;
  if(/Mobi|Android/i.test(ua)) return "Phone";
  if(/Tablet|iPad/i.test(ua)) return "Tablet";
  return "PC";
}

function getBrowserInfo() {
  const ua = navigator.userAgent;
  if (/Chrome/i.test(ua) && !/Edg/i.test(ua)) return "Chrome";
  if (/Safari/i.test(ua) && !/Chrome/i.test(ua)) return "Safari";
  if (/Firefox/i.test(ua)) return "Firefox";
  if (/Edg/i.test(ua)) return "Edge";
  if (/Opera|OPR/i.test(ua)) return "Opera";
  return "Unknown Browser";
}

async function getOSInfo() {
  const ua = navigator.userAgent;
  
  // Try to detect Windows 11 using userAgentData API
  if (/Windows/i.test(ua)) {
    try {
      if (navigator.userAgentData) {
        const platformData = await navigator.userAgentData.getHighEntropyValues(['platformVersion']);
        if (platformData.platformVersion) {
          const majorVersion = parseInt(platformData.platformVersion.split('.')[0]);
          if (majorVersion >= 13) return "Windows 11";
        }
      }
    } catch (e) {
      // If userAgentData fails, fall back to checking Windows version
    }
    
    // Fallback: Check if it's Windows NT 10.0 (could be 10 or 11)
    if (/Windows NT 10/i.test(ua)) return "Windows 10/11";
    if (/Windows/i.test(ua)) return "Windows";
  }
  
  if (/Mac OS X 10_15/i.test(ua)) return "macOS Catalina";
  if (/Mac OS X/i.test(ua)) return "macOS";
  if (/Android 13/i.test(ua)) return "Android 13";
  if (/Android 12/i.test(ua)) return "Android 12";
  if (/Android 11/i.test(ua)) return "Android 11";
  if (/Android 10/i.test(ua)) return "Android 10";
  if (/Android/i.test(ua)) return "Android";
  if (/iPhone OS 17/i.test(ua)) return "iOS 17";
  if (/iPhone OS 16/i.test(ua)) return "iOS 16";
  if (/iPhone OS/i.test(ua)) return "iOS";
  if (/iPad/i.test(ua)) return "iPadOS";
  if (/Linux/i.test(ua)) return "Linux";
  return "Unknown OS";
}

function getDeviceName() {
  const ua = navigator.userAgent;
  
  if (/iPhone/.test(ua)) {
    const model = ua.match(/iPhone\s?(\d+[,\d]*)/);
    return model ? `iPhone ${model[1].replace(',', '.')}` : "iPhone";
  }
  if (/iPad/.test(ua)) return "iPad";
  
  if (/Samsung/.test(ua) || /SM-/.test(ua) || /SAMSUNG/.test(ua)) {
    const model = ua.match(/SM-([A-Z]\d+[A-Z]?)/i) || ua.match(/Galaxy\s([A-Z0-9\s]+)/i);
    if (model) {
      const modelStr = model[1].trim();
      if (modelStr.match(/^[A-Z]\d+/)) {
        const letter = modelStr[0];
        const number = modelStr.match(/\d+/)[0].substring(0, 2);
        return `Samsung Galaxy ${letter}${number}`;
      }
      return `Samsung Galaxy ${modelStr}`;
    }
    return "Samsung";
  }
  
  if (/Xiaomi/.test(ua) || /Mi\s/.test(ua) || /Redmi/.test(ua)) {
    const model = ua.match(/(?:Xiaomi|Mi|Redmi)[\/\s]([A-Z0-9\s]+)/i);
    return model ? `Xiaomi ${model[1].trim().split(/[\s;]/)[0]}` : "Xiaomi";
  }
  
  if (/Huawei/.test(ua) || /HUAWEI/.test(ua)) {
    const model = ua.match(/([A-Z]{3}-[A-Z0-9]+)/i);
    return model ? `Huawei ${model[1]}` : "Huawei";
  }
  
  if (/OnePlus/.test(ua)) {
    const model = ua.match(/OnePlus([A-Z0-9\s]+)/i);
    return model ? `OnePlus ${model[1].trim().split(/[\s;]/)[0]}` : "OnePlus";
  }
  
  if (/Pixel/.test(ua)) {
    const model = ua.match(/Pixel\s?(\d+[a-zA-Z\s]*)/i);
    return model ? `Google Pixel ${model[1].trim()}` : "Google Pixel";
  }
  
  if (/OPPO/.test(ua)) {
    const model = ua.match(/OPPO\s([A-Z0-9]+)/i);
    return model ? `OPPO ${model[1]}` : "OPPO";
  }
  
  if (/vivo/.test(ua)) {
    const model = ua.match(/vivo\s([A-Z0-9]+)/i);
    return model ? `Vivo ${model[1]}` : "Vivo";
  }
  
  if (/Android/.test(ua)) {
    if (!/Mobile/.test(ua)) return "Android Tablet";
    return "Android Phone";
  }
  
  if (/Windows/.test(ua)) {
    if (/Windows NT 10/.test(ua)) return "Windows 10/11 PC";
    if (/Windows NT 6/.test(ua)) return "Windows PC";
    return "Windows PC";
  }
  if (/Macintosh/.test(ua)) {
    if (/Mac OS X/.test(ua)) return "MacBook";
    return "Mac";
  }
  if (/CrOS/.test(ua)) return "Chromebook";
  if (/Linux/.test(ua)) return "Linux PC";
  
  if (/Mobile/.test(ua)) return "Mobile Device";
  
  return "Unknown Device";
}

let deviceId = localStorage.getItem('zorbas_device_id');

if (!deviceId) {
  deviceId = window.crypto && window.crypto.randomUUID ? window.crypto.randomUUID() : 'xxxx-xxxx-xxxx'.replace(/[x]/g, () => (Math.random() * 16 | 0).toString(16));
  localStorage.setItem('zorbas_device_id', deviceId);
}

const deviceName = getDeviceName();
const deviceType = getDeviceType();
const browserInfo = getBrowserInfo();
const deviceRef = ref(db, `devices/${deviceId}`);

// Get OS info and fetch IP address, then save device info
(async () => {
  const osInfo = await getOSInfo();
  
  fetch('https://api.ipify.org?format=json')
    .then(response => response.json())
    .then(data => {
      get(deviceRef).then(snapshot => {
        if (!snapshot.exists()) {
          set(deviceRef, {
            name: deviceName,
            type: deviceType,
            browser: browserInfo,
            os: osInfo,
            ip: data.ip,
            role: "user",
            lastActive: new Date().toLocaleString(),
            timestamp: Date.now()
          });
        } else {
          // Update IP and last active time
          update(deviceRef, {
            ip: data.ip,
            browser: browserInfo,
            os: osInfo,
            lastActive: new Date().toLocaleString()
          });
        }
      });
    })
    .catch(error => {
      // If IP fetch fails, save without IP
      get(deviceRef).then(snapshot => {
        if (!snapshot.exists()) {
          set(deviceRef, {
            name: deviceName,
            type: deviceType,
            browser: browserInfo,
            os: osInfo,
            ip: "Unable to detect",
            role: "user",
            lastActive: new Date().toLocaleString(),
            timestamp: Date.now()
          });
        }
      });
    });
})();

const greekBtn = document.getElementById("greek-btn");
const engBtn = document.getElementById("eng-btn");
const locationSelect = document.getElementById("location");
const storeContainer = document.getElementById("store-container");
const storeSelect = document.getElementById("store");
const submitBtn = document.getElementById("submit-btn");
const messageDiv = document.getElementById("message");

const adminBtn = document.getElementById("admin-btn");
const scheduleBtn = document.getElementById("schedule-btn");
const adminGui = document.getElementById("admin-gui");
const backAdmin = document.getElementById("back-admin");
const seeSubmissionsBtn = document.getElementById("see-submissions");
const resetSubmissionsBtn = document.getElementById("reset-submissions");
const seeUsersBtn = document.getElementById("see-users");

const historyBtn = document.getElementById("history-btn");
const historyGui = document.getElementById("history-gui");
const historyContainer = document.getElementById("history-container");
const backHistoryBtn = document.getElementById("back-history");

const locationsGui = document.getElementById("locations-gui");
const backLocations = document.getElementById("back-locations");
const locationButtons = document.querySelectorAll(".location-btn");

const scheduleGui = document.getElementById("schedule-gui");
const backSchedule = document.getElementById("back-schedule");
const scheduleLocationButtons = document.querySelectorAll(".schedule-location-btn");

const storeGui = document.getElementById("store-gui");
const storeButtonsContainer = document.getElementById("store-buttons-container");
const backStoreBtn = document.getElementById("back-store");

const storeGuiSchedule = document.getElementById("store-gui-schedule");
const storeButtonsContainerSchedule = document.getElementById("store-buttons-container-schedule");
const backStoreBtnSchedule = document.getElementById("back-store-schedule");

const devicesGui = document.getElementById("devices-gui");
const devicesContainer = document.getElementById("devices-container");
const backDevicesBtn = document.getElementById("back-devices");

adminBtn.style.display = "none";

get(deviceRef).then(snapshot => {
  if (snapshot.exists()) {
    const deviceData = snapshot.val();
    if (deviceData.role === "admin") {
      adminBtn.style.display = "block";
    }
  }
});

onValue(deviceRef, snapshot => {
  const deviceData = snapshot.val();
  if (deviceData && deviceData.role === "admin") {
    adminBtn.style.display = "block";
    const editBtn = document.getElementById("edit-schedule-btn");
    if(editBtn) editBtn.style.display = "block";
  } else {
    adminBtn.style.display = "none";
    const editBtn = document.getElementById("edit-schedule-btn");
    if(editBtn) editBtn.style.display = "none";
  }
});

const storeSubmissionsGui = document.createElement("div");
storeSubmissionsGui.id = "store-submissions-gui";
storeSubmissionsGui.style.cssText = `display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:#DAD9D7; z-index:9999; flex-direction:column; align-items:center; justify-content:flex-start; padding-top:50px; overflow-y:auto;`;
const storeTitle = document.createElement("h2");
storeTitle.style.marginBottom="20px";
storeSubmissionsGui.appendChild(storeTitle);
const storeBackBtn = document.createElement("button");
storeBackBtn.textContent = "Back";
storeBackBtn.style.cssText = `background-color:#ff4c4c;color:#fff;padding:12px 20px;border:none;border-radius:6px;font-size:16px;font-weight:bold;cursor:pointer;margin-top:20px;transition:all 0.3s ease;`;
storeBackBtn.addEventListener("mouseover", () => storeBackBtn.style.transform = "translateY(-2px)");
storeBackBtn.addEventListener("mouseout", () => storeBackBtn.style.transform = "translateY(0)");
storeBackBtn.addEventListener("click", ()=>{ storeSubmissionsGui.style.display="none"; storeGui.style.display="flex"; });
storeSubmissionsGui.appendChild(storeBackBtn);
document.body.appendChild(storeSubmissionsGui);

const scheduleSubmissionsGui = document.createElement("div");
scheduleSubmissionsGui.id = "schedule-submissions-gui";
scheduleSubmissionsGui.style.cssText = `display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:#DAD9D7; z-index:9999; flex-direction:column; align-items:center; justify-content:flex-start; padding-top:50px; overflow-y:auto;`;
const scheduleTitle = document.createElement("h2");
scheduleTitle.style.marginBottom="20px";
scheduleSubmissionsGui.appendChild(scheduleTitle);

const printScheduleBtn = document.createElement("button");
printScheduleBtn.className = "print-schedule-btn";
printScheduleBtn.textContent = "Print Schedule";
printScheduleBtn.addEventListener("click", () => window.print());
document.body.appendChild(printScheduleBtn);

const scheduleTableContainer = document.createElement("div");
scheduleTableContainer.style.cssText = `background:#fff; padding:15px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.2); margin-bottom:20px; overflow-x:auto; max-width:90vw; width:auto;`;
const scheduleTable = document.createElement("table");
scheduleTable.id = "schedule-edit-table";
scheduleTable.style.cssText = `border-collapse:collapse; background:#fff; width:max-content; margin:0;`;
for(let i=0; i<12; i++){
  const row = scheduleTable.insertRow();
  for(let j=0; j<12; j++){
    const cell = row.insertCell();
    cell.style.cssText = `border:1px solid #ccc; padding:8px; min-width:70px; min-height:35px; text-align:center; white-space:nowrap;`;
    cell.contentEditable = "false";
  }
}
scheduleTableContainer.appendChild(scheduleTable);
scheduleSubmissionsGui.appendChild(scheduleTableContainer);

let currentEditingStore = "";
let currentEditingLocation = "";
let isEditMode = false;

const editScheduleBtn = document.createElement("button");
editScheduleBtn.textContent = "Edit Schedule";
editScheduleBtn.id = "edit-schedule-btn";
editScheduleBtn.style.cssText = `
  position: fixed;
  bottom: 20px;
  right: 20px;
  background-color:#E8DA89;
  color:#000;
  padding:12px 20px;
  border:none;
  border-radius:6px;
  font-size:16px;
  font-weight:bold;
  cursor:pointer;
  display:none;
  z-index:10001;
  transition: all 0.3s ease;
`;
editScheduleBtn.addEventListener("click", ()=>{ 
  if(!isEditMode){
    enableTableEditing();
    editScheduleBtn.textContent = "Save Schedule";
    editScheduleBtn.style.backgroundColor = "#90EE90";
    document.getElementById("toolbar-toggle").style.display = "flex";
    isEditMode = true;
  } else {
    disableTableEditing();
    saveScheduleToFirebase();
    editScheduleBtn.textContent = "Edit Schedule";
    editScheduleBtn.style.backgroundColor = "#E8DA89";
    document.getElementById("toolbar-toggle").style.display = "none";
    document.getElementById("toolbar-sidebar").classList.remove("open");
    document.getElementById("toolbar-overlay").classList.remove("show");
    isEditMode = false;
  }
});
scheduleSubmissionsGui.appendChild(editScheduleBtn);

const scheduleBackBtn = document.createElement("button");
scheduleBackBtn.textContent = "Back";
scheduleBackBtn.style.cssText = `
  position: fixed;
  bottom: 20px;
  left: 20px;
  background-color:#ff4c4c;
  color:#fff;
  padding:12px 20px;
  border:none;
  border-radius:6px;
  font-size:16px;
  font-weight:bold;
  cursor:pointer;
  z-index:10001;
  transition: all 0.3s ease;
`;
scheduleBackBtn.addEventListener("mouseover", () => scheduleBackBtn.style.transform = "translateY(-2px)");
scheduleBackBtn.addEventListener("mouseout", () => scheduleBackBtn.style.transform = "translateY(0)");
scheduleBackBtn.addEventListener("click", ()=>{ 
  scheduleSubmissionsGui.style.display="none"; 
  storeGuiSchedule.style.display="flex";
  printScheduleBtn.style.display = "none";
  isEditMode = false;
  const editBtn = document.getElementById("edit-schedule-btn");
  const toolbarToggle = document.getElementById("toolbar-toggle");
  const toolbarSidebar = document.getElementById("toolbar-sidebar");
  const toolbarOverlay = document.getElementById("toolbar-overlay");
  if(editBtn){
    disableTableEditing();
    editBtn.textContent = "Edit Schedule";
    editBtn.style.backgroundColor = "#E8DA89";
  }
  if(toolbarToggle) toolbarToggle.style.display = "none";
  if(toolbarSidebar) toolbarSidebar.classList.remove("open");
  if(toolbarOverlay) toolbarOverlay.classList.remove("show");
});
scheduleSubmissionsGui.appendChild(scheduleBackBtn);
document.body.appendChild(scheduleSubmissionsGui);

const toolbarToggle = document.createElement("button");
toolbarToggle.id = "toolbar-toggle";
toolbarToggle.className = "toolbar-toggle";
toolbarToggle.innerHTML = `
  <span></span>
  <span></span>
  <span></span>
`;
document.body.appendChild(toolbarToggle);

const toolbarOverlay = document.createElement("div");
toolbarOverlay.id = "toolbar-overlay";
toolbarOverlay.className = "toolbar-overlay";
document.body.appendChild(toolbarOverlay);

const toolbarSidebar = document.createElement("div");
toolbarSidebar.id = "toolbar-sidebar";
toolbarSidebar.className = "toolbar-sidebar";
toolbarSidebar.innerHTML = `
  <button class="toolbar-close">‚úï</button>
  
  <div class="toolbar-section">
    <div class="toolbar-section-title">Text Style</div>
    <button class="toolbar-button" data-action="bold">
      <span class="toolbar-button-icon" style="font-weight:bold;">B</span>
      <span>Bold</span>
    </button>
    <button class="toolbar-button" data-action="italic">
      <span class="toolbar-button-icon" style="font-style:italic;">I</span>
      <span>Italic</span>
    </button>
    <button class="toolbar-button" data-action="underline">
      <span class="toolbar-button-icon" style="text-decoration:underline;">U</span>
      <span>Underline</span>
    </button>
  </div>
  
  <div class="toolbar-section">
    <div class="toolbar-section-title">Alignment</div>
    <button class="toolbar-button" data-action="align-left">
      <span class="toolbar-button-icon">‚¨Ö</span>
      <span>Align Left</span>
    </button>
    <button class="toolbar-button" data-action="align-center">
      <span class="toolbar-button-icon">‚Üî</span>
      <span>Align Center</span>
    </button>
    <button class="toolbar-button" data-action="align-right">
      <span class="toolbar-button-icon">‚û°</span>
      <span>Align Right</span>
    </button>
  </div>
  
  <div class="toolbar-section">
    <div class="toolbar-section-title">Table Structure</div>
    <button class="toolbar-button" data-action="add-row">
      <span class="toolbar-button-icon">+</span>
      <span>Add Row</span>
    </button>
    <button class="toolbar-button" data-action="remove-row">
      <span class="toolbar-button-icon">‚àí</span>
      <span>Remove Row</span>
    </button>
    <button class="toolbar-button" data-action="add-column">
      <span class="toolbar-button-icon">+</span>
      <span>Add Column</span>
    </button>
    <button class="toolbar-button" data-action="remove-column">
      <span class="toolbar-button-icon">‚àí</span>
      <span>Remove Column</span>
    </button>
  </div>
  
  <div class="toolbar-section">
    <div class="toolbar-section-title">Cell Actions</div>
    <button class="toolbar-button" data-action="color-cell">
      <span class="toolbar-button-icon">üé®</span>
      <span>Color Cell</span>
    </button>
    <button class="toolbar-button" data-action="color-text">
      <span class="toolbar-button-icon">‚úèÔ∏è</span>
      <span>Color Text</span>
    </button>
    <button class="toolbar-button" data-action="clear-cell">
      <span class="toolbar-button-icon">üóë</span>
      <span>Clear Cell</span>
    </button>
  </div>
`;
document.body.appendChild(toolbarSidebar);

toolbarToggle.addEventListener("click", () => {
  toolbarSidebar.classList.toggle("open");
  toolbarOverlay.classList.toggle("show");
});

toolbarOverlay.addEventListener("click", () => {
  toolbarSidebar.classList.remove("open");
  toolbarOverlay.classList.remove("show");
});

toolbarSidebar.querySelector(".toolbar-close").addEventListener("click", () => {
  toolbarSidebar.classList.remove("open");
  toolbarOverlay.classList.remove("show");
});

let lastSelectedCell = null;

document.addEventListener("click", (e) => {
  if(e.target.tagName === "TD" && e.target.closest("#schedule-edit-table") && isEditMode){
    if(lastSelectedCell){
      lastSelectedCell.style.outline = "";
    }
    lastSelectedCell = e.target;
    lastSelectedCell.style.outline = "3px solid #E8DA89";
  }
});

toolbarSidebar.addEventListener("click", (e) => {
  if(e.target.closest(".toolbar-button")){
    const button = e.target.closest(".toolbar-button");
    const action = button.dataset.action;
    const table = document.getElementById("schedule-edit-table");
    const selectedCell = lastSelectedCell;
    
    if(action === "bold"){
      if(selectedCell && selectedCell.tagName === "TD"){
        const currentWeight = window.getComputedStyle(selectedCell).fontWeight;
        const isBold = currentWeight === "bold" || parseInt(currentWeight) >= 600;
        selectedCell.style.fontWeight = isBold ? "normal" : "bold";
        showPopup(t("boldApplied"), "success");
      } else {
        showPopup(t("selectCellFirst"), "error");
      }
    }
    else if(action === "italic"){
      if(selectedCell && selectedCell.tagName === "TD"){
        const currentStyle = window.getComputedStyle(selectedCell).fontStyle;
        selectedCell.style.fontStyle = currentStyle === "italic" ? "normal" : "italic";
        showPopup(t("italicApplied"), "success");
      } else {
        showPopup(t("selectCellFirst"), "error");
      }
    }
    else if(action === "underline"){
      if(selectedCell && selectedCell.tagName === "TD"){
        const currentDecoration = window.getComputedStyle(selectedCell).textDecoration;
        const hasUnderline = currentDecoration.includes("underline");
        selectedCell.style.textDecoration = hasUnderline ? "none" : "underline";
        showPopup(t("underlineApplied"), "success");
      } else {
        showPopup(t("selectCellFirst"), "error");
      }
    }
    else if(action === "align-left"){
      if(selectedCell && selectedCell.tagName === "TD"){
        selectedCell.style.textAlign = "left";
        showPopup(t("alignedLeft"), "success");
      } else {
        showPopup(t("selectCellFirst"), "error");
      }
    }
    else if(action === "align-center"){
      if(selectedCell && selectedCell.tagName === "TD"){
        selectedCell.style.textAlign = "center";
        showPopup(t("alignedCenter"), "success");
      } else {
        showPopup(t("selectCellFirst"), "error");
      }
    }
    else if(action === "align-right"){
      if(selectedCell && selectedCell.tagName === "TD"){
        selectedCell.style.textAlign = "right";
        showPopup(t("alignedRight"), "success");
      } else {
        showPopup(t("selectCellFirst"), "error");
      }
    }
    else if(action === "color-cell"){
      if(selectedCell && selectedCell.tagName === "TD"){
        const colorInput = document.createElement("input");
        colorInput.type = "color";
        colorInput.value = "#ffffff";
        colorInput.style.position = "fixed";
        colorInput.style.opacity = "0";
        colorInput.style.pointerEvents = "none";
        document.body.appendChild(colorInput);
        
        colorInput.addEventListener("change", (event) => {
          selectedCell.style.backgroundColor = event.target.value;
          showPopup(t("cellColorChanged"), "success");
          colorInput.remove();
        });
        
        colorInput.addEventListener("cancel", () => {
          colorInput.remove();
        });
        
        colorInput.click();
      } else {
        showPopup(t("selectCellFirst"), "error");
      }
    }
    else if(action === "color-text"){
      if(selectedCell && selectedCell.tagName === "TD"){
        const colorInput = document.createElement("input");
        colorInput.type = "color";
        colorInput.value = "#000000";
        colorInput.style.position = "fixed";
        colorInput.style.opacity = "0";
        colorInput.style.pointerEvents = "none";
        document.body.appendChild(colorInput);
        
        colorInput.addEventListener("change", (event) => {
          selectedCell.style.color = event.target.value;
          showPopup(t("textColorChanged"), "success");
          colorInput.remove();
        });
        
        colorInput.addEventListener("cancel", () => {
          colorInput.remove();
        });
        
        colorInput.click();
      } else {
        showPopup(t("selectCellFirst"), "error");
      }
    }
    else if(action === "add-row"){
      const newRow = table.insertRow();
      for(let i = 0; i < table.rows[0].cells.length; i++){
        const cell = newRow.insertCell();
        cell.style.cssText = `border:1px solid #ccc; padding:8px; min-width:70px; min-height:35px; text-align:center; white-space:nowrap;`;
        if(isEditMode){
          cell.contentEditable = "true";
          cell.style.backgroundColor = "#fffacd";
          cell.style.cursor = "text";
        }
      }
      showPopup(currentLang === "GR" ? "ŒìœÅŒ±ŒºŒºŒÆ œÄœÅŒøœÉœÑŒ≠Œ∏Œ∑Œ∫Œµ" : "Row added", "success");
    }
    else if(action === "remove-row"){
      if(table.rows.length > 1){
        table.deleteRow(table.rows.length - 1);
        showPopup(currentLang === "GR" ? "ŒìœÅŒ±ŒºŒºŒÆ Œ±œÜŒ±ŒπœÅŒ≠Œ∏Œ∑Œ∫Œµ" : "Row removed", "success");
      } else {
        showPopup(currentLang === "GR" ? "ŒîŒµŒΩ ŒºœÄŒøœÅŒµŒØ ŒΩŒ± Œ±œÜŒ±ŒπœÅŒµŒ∏ŒµŒØ Œ∑ œÑŒµŒªŒµœÖœÑŒ±ŒØŒ± Œ≥œÅŒ±ŒºŒºŒÆ" : "Cannot remove last row", "error");
      }
    }
    else if(action === "add-column"){
      for(let i = 0; i < table.rows.length; i++){
        const cell = table.rows[i].insertCell();
        cell.style.cssText = `border:1px solid #ccc; padding:8px; min-width:70px; min-height:35px; text-align:center; white-space:nowrap;`;
        if(isEditMode){
          cell.contentEditable = "true";
          cell.style.backgroundColor = "#fffacd";
          cell.style.cursor = "text";
        }
      }
      showPopup(currentLang === "GR" ? "Œ£œÑŒÆŒªŒ∑ œÄœÅŒøœÉœÑŒ≠Œ∏Œ∑Œ∫Œµ" : "Column added", "success");
    }
    else if(action === "remove-column"){
      if(table.rows[0].cells.length > 1){
        for(let i = 0; i < table.rows.length; i++){
          table.rows[i].deleteCell(table.rows[i].cells.length - 1);
        }
        showPopup(currentLang === "GR" ? "Œ£œÑŒÆŒªŒ∑ Œ±œÜŒ±ŒπœÅŒ≠Œ∏Œ∑Œ∫Œµ" : "Column removed", "success");
      } else {
        showPopup(currentLang === "GR" ? "ŒîŒµŒΩ ŒºœÄŒøœÅŒµŒØ ŒΩŒ± Œ±œÜŒ±ŒπœÅŒµŒ∏ŒµŒØ Œ∑ œÑŒµŒªŒµœÖœÑŒ±ŒØŒ± œÉœÑŒÆŒªŒ∑" : "Cannot remove last column", "error");
      }
    }
    else if(action === "clear-cell"){
      if(selectedCell && selectedCell.tagName === "TD"){
        selectedCell.textContent = "";
        showPopup(currentLang === "GR" ? "ŒöŒµŒªŒØ Œ∫Œ±Œ∏Œ±œÅŒØœÉœÑŒ∑Œ∫Œµ" : "Cell cleared", "success");
      } else {
        showPopup(t("selectCellFirst"), "error");
      }
    }
  }
});

function enableTableEditing(){
  const cells = document.querySelectorAll("#schedule-edit-table td");
  cells.forEach(cell => {
    cell.contentEditable = "true";
    cell.style.backgroundColor = "#fffacd";
    cell.style.cursor = "text";
  });
}

function disableTableEditing(){
  const cells = document.querySelectorAll("#schedule-edit-table td");
  cells.forEach(cell => {
    cell.contentEditable = "false";
    if(cell.style.backgroundColor === "rgb(255, 250, 205)" || 
       cell.style.backgroundColor === "#fffacd" || 
       !cell.style.backgroundColor || 
       cell.style.backgroundColor === ""){
      cell.style.backgroundColor = "#fff";
    }
    cell.style.cursor = "default";
  });
  
  if(lastSelectedCell){
    lastSelectedCell.style.outline = "";
    lastSelectedCell = null;
  }
}

function saveScheduleToFirebase(){
  const table = document.getElementById("schedule-edit-table");
  const scheduleData = [];
  for(let i=0; i<table.rows.length; i++){
    const rowData = [];
    for(let j=0; j<table.rows[i].cells.length; j++){
      const cell = table.rows[i].cells[j];
      const computedStyle = window.getComputedStyle(cell);
      
      let bgColor = cell.style.backgroundColor || "";
      if(!bgColor && computedStyle.backgroundColor !== "rgba(0, 0, 0, 0)" && computedStyle.backgroundColor !== "transparent"){
        bgColor = computedStyle.backgroundColor;
      }
      
      let textColor = cell.style.color || "";
      if(!textColor && computedStyle.color){
        textColor = computedStyle.color;
      }
      
      rowData.push({
        text: cell.textContent,
        bold: computedStyle.fontWeight === "bold" || parseInt(computedStyle.fontWeight) >= 600,
        italic: computedStyle.fontStyle === "italic",
        underline: computedStyle.textDecoration.includes("underline"),
        align: cell.style.textAlign || computedStyle.textAlign || "center",
        bgColor: bgColor,
        textColor: textColor
      });
    }
    scheduleData.push(rowData);
  }
  const schedulePath = `schedules/${currentEditingLocation}/${currentEditingStore}`;
  set(ref(db, schedulePath), scheduleData);
  showPopup(currentLang === "GR" ? "Œ§Œø œÄœÅœåŒ≥œÅŒ±ŒºŒºŒ± Œ±œÄŒøŒ∏Œ∑Œ∫ŒµœçœÑŒ∑Œ∫Œµ!" : "Schedule saved!", "success");
}

function loadScheduleFromFirebase(location, store){
  currentEditingLocation = location;
  currentEditingStore = store;
  const schedulePath = `schedules/${location}/${store}`;
  
  onValue(ref(db, schedulePath), snapshot => {
    const table = document.getElementById("schedule-edit-table");
    if(snapshot.exists()){
      const scheduleData = snapshot.val();
      
      while(table.rows.length < scheduleData.length){
        const newRow = table.insertRow();
        for(let j = 0; j < (scheduleData[0].length || 12); j++){
          const cell = newRow.insertCell();
          cell.style.cssText = `border:1px solid #ccc; padding:8px; min-width:70px; min-height:35px; text-align:center; white-space:nowrap;`;
          cell.contentEditable = "false";
        }
      }
      
      for(let i=0; i<scheduleData.length && i<table.rows.length; i++){
        while(table.rows[i].cells.length < scheduleData[i].length){
          const cell = table.rows[i].insertCell();
          cell.style.cssText = `border:1px solid #ccc; padding:8px; min-width:70px; min-height:35px; text-align:center; white-space:nowrap;`;
          cell.contentEditable = "false";
        }
        
        for(let j=0; j<scheduleData[i].length && j<table.rows[i].cells.length; j++){
          const cellData = scheduleData[i][j];
          const cell = table.rows[i].cells[j];
          
          if(typeof cellData === "object"){
            cell.textContent = cellData.text || "";
            cell.style.fontWeight = cellData.bold ? "bold" : "normal";
            cell.style.fontStyle = cellData.italic ? "italic" : "normal";
            cell.style.textDecoration = cellData.underline ? "underline" : "none";
            cell.style.textAlign = cellData.align || "center";
            cell.style.backgroundColor = cellData.bgColor || "";
            cell.style.color = cellData.textColor || "";
          } else {
            cell.textContent = cellData || "";
          }
        }
      }
    } else {
      for(let i=0; i<table.rows.length; i++){
        for(let j=0; j<table.rows[i].cells.length; j++){
          table.rows[i].cells[j].textContent = "";
          table.rows[i].cells[j].style.fontWeight = "normal";
          table.rows[i].cells[j].style.fontStyle = "normal";
          table.rows[i].cells[j].style.textDecoration = "none";
          table.rows[i].cells[j].style.textAlign = "center";
          table.rows[i].cells[j].style.backgroundColor = "";
          table.rows[i].cells[j].style.color = "";
        }
      }
    }
  });
}

let currentLang = "EN";


const translations = {
  EN: {
    // Main Form
    name: "Name",
    month: "Month",
    day: "Day",
    shift: "Shift",
    location: "Location",
    store: "Store",
    submit: "Submit",
    adminGui: "Admin GUI",
    scheduleGui: "Schedule GUI",
    myHistory: "My History",
    namePlaceholder: "Fill out your name",
    dayPlaceholder: "Fill out your day",
    selectStore: "Select a store",
    
    // Admin GUI
    adminPanel: "Admin Panel",
    seeSubmissions: "See Submissions",
    resetSubmissions: "Reset all submissions",
    seeUsers: "See Users",
    back: "Back",
    
    // Locations
    selectLocation: "Select Location",
    nicosia: "NICOSIA",
    larnaca: "LARNACA",
    famagusta: "FAMAGUSTA",
    limassol: "LIMASSOL",
    pafos: "PAFOS",
    
    // Submissions
    storeSubmissions: "Submissions",
    acceptSubmission: "Accept",
    declineSubmission: "Decline",
    noSubmissions: "No pending submissions",
    
    // Schedule
    schedule: "Schedule",
    editSchedule: "Edit Schedule",
    saveSchedule: "Save Schedule",
    lockSchedule: "Lock Schedule",
    printSchedule: "Print Schedule",
    
    // Devices
    devices: "Connected Devices",
    device: "Device",
    browser: "Browser",
    os: "OS",
    ip: "IP",
    lastActive: "Last active",
    user: "User",
    admin: "Admin",
    noDevices: "No devices found",
    
    // History
    noHistory: "No submission history",
    status: "Status",
    pending: "Pending",
    accepted: "Accepted",
    declined: "Declined",
    
    // Messages
    submitSuccess: "You successfully submitted!",
    fillAllFields: "Please fill in all fields.",
    acceptedSuccess: "You successfully accepted this submission",
    declinedSuccess: "You successfully declined this submission",
    resetSuccess: "All submissions have been reset!",
    scheduleSaved: "Schedule saved!",
    selectCellFirst: "Select a cell first",
    boldApplied: "Bold applied",
    italicApplied: "Italic applied",
    underlineApplied: "Underline applied",
    alignedLeft: "Aligned left",
    alignedCenter: "Aligned center",
    alignedRight: "Aligned right",
    cellColorChanged: "Cell color changed",
    textColorChanged: "Text color changed"
  },
  GR: {
    // Main Form
    name: "ŒåŒΩŒøŒºŒ±",
    month: "ŒúŒÆŒΩŒ±œÇ",
    day: "ŒóŒºŒ≠œÅŒ±",
    shift: "ŒíŒ¨œÅŒ¥ŒπŒ±",
    location: "Œ§ŒøœÄŒøŒ∏ŒµœÉŒØŒ±",
    store: "ŒöŒ±œÑŒ¨œÉœÑŒ∑ŒºŒ±",
    submit: "Œ•œÄŒøŒ≤ŒøŒªŒÆ",
    adminGui: "ŒîŒπŒ±œáŒµŒπœÅŒπœÉœÑŒÆœÇ",
    scheduleGui: "Œ†œÅœåŒ≥œÅŒ±ŒºŒºŒ±",
    myHistory: "ŒôœÉœÑŒøœÅŒπŒ∫œå",
    namePlaceholder: "Œ£œÖŒºœÄŒªŒ∑œÅœéœÉœÑŒµ œÑŒø œåŒΩŒøŒºŒ¨ œÉŒ±œÇ",
    dayPlaceholder: "Œ£œÖŒºœÄŒªŒ∑œÅœéœÉœÑŒµ œÑŒ∑ ŒºŒ≠œÅŒ± œÉŒ±œÇ",
    selectStore: "ŒïœÄŒπŒªŒ≠ŒæœÑŒµ Œ∫Œ±œÑŒ¨œÉœÑŒ∑ŒºŒ±",
    
    // Admin GUI
    adminPanel: "Œ†ŒØŒΩŒ±Œ∫Œ±œÇ ŒîŒπŒ±œáŒµŒØœÅŒπœÉŒ∑œÇ",
    seeSubmissions: "ŒîŒµŒØœÑŒµ Œ•œÄŒøŒ≤ŒøŒªŒ≠œÇ",
    resetSubmissions: "ŒïœÄŒ±ŒΩŒ±œÜŒøœÅŒ¨ œåŒªœâŒΩ œÑœâŒΩ œÖœÄŒøŒ≤ŒøŒªœéŒΩ",
    seeUsers: "ŒîŒµŒØœÑŒµ ŒßœÅŒÆœÉœÑŒµœÇ",
    back: "Œ†ŒØœÉœâ",
    
    // Locations
    selectLocation: "ŒïœÄŒπŒªŒ≠ŒæœÑŒµ Œ§ŒøœÄŒøŒ∏ŒµœÉŒØŒ±",
    nicosia: "ŒõŒïŒ•ŒöŒ©Œ£ŒôŒë",
    larnaca: "ŒõŒëŒ°ŒùŒëŒöŒë",
    famagusta: "ŒëŒúŒúŒüŒßŒ©Œ£Œ§ŒüŒ£",
    limassol: "ŒõŒïŒúŒïŒ£ŒüŒ£",
    pafos: "Œ†ŒëŒ¶ŒüŒ£",
    
    // Submissions
    storeSubmissions: "Œ•œÄŒøŒ≤ŒøŒªŒ≠œÇ",
    acceptSubmission: "ŒëœÄŒøŒ¥ŒøœáŒÆ",
    declineSubmission: "ŒëœÄœåœÅœÅŒπœàŒ∑",
    noSubmissions: "ŒîŒµŒΩ œÖœÄŒ¨œÅœáŒøœÖŒΩ ŒµŒ∫Œ∫œÅŒµŒºŒµŒØœÇ œÖœÄŒøŒ≤ŒøŒªŒ≠œÇ",
    
    // Schedule
    schedule: "Œ†œÅœåŒ≥œÅŒ±ŒºŒºŒ±",
    editSchedule: "ŒïœÄŒµŒæŒµœÅŒ≥Œ±œÉŒØŒ± Œ†œÅŒøŒ≥œÅŒ¨ŒºŒºŒ±œÑŒøœÇ",
    saveSchedule: "ŒëœÄŒøŒ∏ŒÆŒ∫ŒµœÖœÉŒ∑ Œ†œÅŒøŒ≥œÅŒ¨ŒºŒºŒ±œÑŒøœÇ",
    lockSchedule: "ŒöŒªŒµŒØŒ¥œâŒºŒ± Œ†œÅŒøŒ≥œÅŒ¨ŒºŒºŒ±œÑŒøœÇ",
    printSchedule: "ŒïŒ∫œÑœçœÄœâœÉŒ∑ Œ†œÅŒøŒ≥œÅŒ¨ŒºŒºŒ±œÑŒøœÇ",
    
    // Devices
    devices: "Œ£œÖŒΩŒ¥ŒµŒ¥ŒµŒºŒ≠ŒΩŒµœÇ Œ£œÖœÉŒ∫ŒµœÖŒ≠œÇ",
    device: "Œ£œÖœÉŒ∫ŒµœÖŒÆ",
    browser: "Œ†ŒµœÅŒπŒ∑Œ≥Œ∑œÑŒÆœÇ",
    os: "ŒõŒµŒπœÑŒøœÖœÅŒ≥ŒπŒ∫œå",
    ip: "IP",
    lastActive: "Œ§ŒµŒªŒµœÖœÑŒ±ŒØŒ± Œ¥œÅŒ±œÉœÑŒ∑œÅŒπœåœÑŒ∑œÑŒ±",
    user: "ŒßœÅŒÆœÉœÑŒ∑œÇ",
    admin: "ŒîŒπŒ±œáŒµŒπœÅŒπœÉœÑŒÆœÇ",
    noDevices: "ŒîŒµŒΩ Œ≤œÅŒ≠Œ∏Œ∑Œ∫Œ±ŒΩ œÉœÖœÉŒ∫ŒµœÖŒ≠œÇ",
    
    // History
    noHistory: "ŒîŒµŒΩ œÖœÄŒ¨œÅœáŒµŒπ ŒπœÉœÑŒøœÅŒπŒ∫œå",
    status: "ŒöŒ±œÑŒ¨œÉœÑŒ±œÉŒ∑",
    pending: "ŒïŒ∫Œ∫œÅŒµŒºŒµŒØ",
    accepted: "ŒëœÄŒøŒ¥ŒµŒ∫œÑŒÆ",
    declined: "ŒëœÄŒøœÅœÅŒØœÜŒ∏Œ∑Œ∫Œµ",
    
    // Messages
    submitSuccess: "Œ•œÄŒøŒ≤ŒªŒÆŒ∏Œ∑Œ∫Œµ ŒºŒµ ŒµœÄŒπœÑœÖœáŒØŒ±!",
    fillAllFields: "Œ†Œ±œÅŒ±Œ∫Œ±Œªœé œÉœÖŒºœÄŒªŒ∑œÅœéœÉœÑŒµ œåŒªŒ± œÑŒ± œÄŒµŒ¥ŒØŒ±.",
    acceptedSuccess: "Œó œÖœÄŒøŒ≤ŒøŒªŒÆ Œ≠Œ≥ŒπŒΩŒµ Œ±œÄŒøŒ¥ŒµŒ∫œÑŒÆ!",
    declinedSuccess: "Œó œÖœÄŒøŒ≤ŒøŒªŒÆ Œ±œÄŒøœÅœÅŒØœÜŒ∏Œ∑Œ∫Œµ!",
    resetSuccess: "ŒåŒªŒµœÇ ŒøŒπ œÖœÄŒøŒ≤ŒøŒªŒ≠œÇ Œ¥ŒπŒ±Œ≥œÅŒ¨œÜŒ∑Œ∫Œ±ŒΩ!",
    scheduleSaved: "Œ§Œø œÄœÅœåŒ≥œÅŒ±ŒºŒºŒ± Œ±œÄŒøŒ∏Œ∑Œ∫ŒµœçœÑŒ∑Œ∫Œµ!",
    selectCellFirst: "ŒïœÄŒπŒªŒ≠ŒæœÑŒµ Œ≠ŒΩŒ± Œ∫ŒµŒªŒØ œÄœÅœéœÑŒ±",
    boldApplied: "ŒàŒΩœÑŒøŒΩŒ∑ Œ≥œÅŒ±ŒºŒºŒ±œÑŒøœÉŒµŒπœÅŒ¨ ŒµœÜŒ±œÅŒºœåœÉœÑŒ∑Œ∫Œµ",
    italicApplied: "Œ†ŒªŒ¨Œ≥ŒπŒ± Œ≥œÅŒ±ŒºŒºŒ±œÑŒøœÉŒµŒπœÅŒ¨ ŒµœÜŒ±œÅŒºœåœÉœÑŒ∑Œ∫Œµ",
    underlineApplied: "Œ•œÄŒøŒ≥œÅŒ¨ŒºŒºŒπœÉŒ∑ ŒµœÜŒ±œÅŒºœåœÉœÑŒ∑Œ∫Œµ",
    alignedLeft: "Œ£œÑŒøŒØœáŒπœÉŒ∑ Œ±œÅŒπœÉœÑŒµœÅŒ¨",
    alignedCenter: "Œ£œÑŒøŒØœáŒπœÉŒ∑ œÉœÑŒø Œ∫Œ≠ŒΩœÑœÅŒø",
    alignedRight: "Œ£œÑŒøŒØœáŒπœÉŒ∑ Œ¥ŒµŒæŒπŒ¨",
    cellColorChanged: "ŒßœÅœéŒºŒ± Œ∫ŒµŒªŒπŒøœç Œ¨ŒªŒªŒ±ŒæŒµ",
    textColorChanged: "ŒßœÅœéŒºŒ± Œ∫ŒµŒπŒºŒ≠ŒΩŒøœÖ Œ¨ŒªŒªŒ±ŒæŒµ"
  }
};


function t(key) {
  return translations[currentLang][key] || key;
}

const stores = {
  NICOSIA: {EN:["Coffee Berry","Makariou Unihalls","Trinity Shop","Nicosia Mall","Kokkinotrimithia","Agios Pavlos","Chatziiosif","Pallouriotissa"], GR:["Coffee Berry","Makariou Unihalls","Trinity Shop","Nicosia Mall","ŒöŒøŒ∫Œ∫ŒπŒΩŒøœÑœÅŒπŒºŒπŒ∏ŒπŒ¨","ŒÜŒ≥ŒπŒøœÇ Œ†Œ±œçŒªŒøœÇ","ŒßŒ±œÑŒ∂Œ∑ŒπœâœÉŒ∑œÜ","Œ†Œ±ŒªŒªŒøœÖœÅŒπœéœÑŒπœÉœÉŒ±"]},
  LARNACA: {EN:["Timagia","Makariou","Faneromeni","Oroklini","Aradippou","Kiti"], GR:["Œ§ŒπŒºŒ¨Œ≥ŒπŒ±","ŒúŒ±Œ∫Œ±œÅŒØŒøœÖ","Œ¶Œ±ŒΩŒµœÅœâŒºŒ≠ŒΩŒ∑","ŒüœÅœåŒ∫ŒªŒπŒΩŒ∑","ŒëœÅŒ±Œ¥ŒØœÄœÄŒøœÖ","ŒöŒØœÑŒπ"]},
  FAMAGUSTA: {EN:["Paralimni","Protaras"], GR:["Œ†Œ±œÅŒ±ŒªŒØŒºŒΩŒπ","Œ†œÅœâœÑŒ±œÅŒ¨œÇ"]},
  LIMASSOL: {EN:["Paphou","Akadimias","NAAFI","Omirou"], GR:["Œ†Œ¨œÜŒøœÖ","ŒëŒ∫Œ±Œ¥Œ∑ŒºŒØŒ±œÇ","NAAFI","ŒåŒºŒ∑œÅŒøœÖ"]},
  PAFOS: {EN:["El. Venizelou","Geroskipou","Ellados","Apostolou Pavlou"], GR:["ŒïŒª. ŒíŒµŒΩŒπŒ∂Œ≠ŒªŒøœÖ","ŒìŒµœÅŒøœÉŒ∫ŒÆœÄŒøœÖ","ŒïŒªŒªŒ¨Œ¥ŒøœÇ","ŒëœÄŒøœÉœÑœåŒªŒøœÖ Œ†Œ±œçŒªŒøœÖ"]}
};

function switchLang(lang){
  currentLang = lang;
  const t = translations[lang];
  
  greekBtn.classList.toggle("active", lang === "GR");
  engBtn.classList.toggle("active", lang === "EN");
  
  // Main Form
  document.getElementById("label-name").textContent = t.name;
  document.getElementById("label-month").textContent = t.month;
  document.getElementById("label-day").textContent = t.day;
  document.getElementById("label-shift").textContent = t.shift;
  document.getElementById("label-location").textContent = t.location;
  document.getElementById("label-store").textContent = t.store;
  document.getElementById("name").placeholder = t.namePlaceholder;
  document.getElementById("day").placeholder = t.dayPlaceholder;
  submitBtn.textContent = t.submit;
  adminBtn.textContent = t.adminGui;
  scheduleBtn.textContent = t.scheduleGui;
  historyBtn.textContent = t.myHistory;
  
  // Admin GUI
  const adminTitle = document.querySelector("#admin-gui h2");
  if(adminTitle) adminTitle.textContent = t.adminPanel;
  const seeSubmBtn = document.getElementById("see-submissions");
  if(seeSubmBtn) seeSubmBtn.textContent = t.seeSubmissions;
  const resetBtn = document.getElementById("reset-submissions");
  if(resetBtn) resetBtn.textContent = t.resetSubmissions;
  const seeUsersBtn = document.getElementById("see-users");
  if(seeUsersBtn) seeUsersBtn.textContent = t.seeUsers;
  document.querySelectorAll('[id^="back-"]').forEach(btn => {
    if(btn.textContent.includes("Back") || btn.textContent.includes("Œ†ŒØœÉœâ")) {
      btn.textContent = t.back;
    }
  });
  
  // Locations GUI
  const locTitle = document.querySelector("#locations-gui h2");
  if(locTitle) locTitle.textContent = t.selectLocation;
  const locationBtns = document.querySelectorAll(".location-btn");
  if(locationBtns.length > 0) {
    locationBtns[0].textContent = t.nicosia;
    locationBtns[1].textContent = t.larnaca;
    locationBtns[2].textContent = t.famagusta;
    locationBtns[3].textContent = t.limassol;
    locationBtns[4].textContent = t.pafos;
  }
  
  // Schedule GUI
  const schedLocTitle = document.querySelector("#schedule-gui h2");
  if(schedLocTitle) schedLocTitle.textContent = t.selectLocation;
  const schedLocationBtns = document.querySelectorAll(".schedule-location-btn");
  if(schedLocationBtns.length > 0) {
    schedLocationBtns[0].textContent = t.nicosia;
    schedLocationBtns[1].textContent = t.larnaca;
    schedLocationBtns[2].textContent = t.famagusta;
    schedLocationBtns[3].textContent = t.limassol;
    schedLocationBtns[4].textContent = t.pafos;
  }
  
  // Schedule Editing Buttons
  const editScheduleBtn = document.getElementById("edit-schedule-btn");
  if(editScheduleBtn && editScheduleBtn.textContent.includes("Edit")) {
    editScheduleBtn.textContent = "‚úèÔ∏è " + t.editSchedule;
  } else if(editScheduleBtn) {
    editScheduleBtn.textContent = "üîí " + t.lockSchedule;
  }
  const saveScheduleBtn = document.getElementById("save-schedule-btn");
  if(saveScheduleBtn) saveScheduleBtn.textContent = "üíæ " + t.saveSchedule;
  const printScheduleBtn = document.getElementById("print-schedule-btn");
  if(printScheduleBtn) printScheduleBtn.textContent = "üñ®Ô∏è " + t.printSchedule;
  
  // Devices GUI
  const devicesTitle = document.querySelector("#devices-gui h2");
  if(devicesTitle) devicesTitle.textContent = t.devices;
  
  // History GUI
  const historyTitle = document.querySelector("#history-gui h2");
  if(historyTitle) historyTitle.textContent = t.myHistory;
  
  // Update store dropdown if visible
  if(storeContainer.classList.contains("show")){
    updateStores(locationSelect.value);
  }
}

greekBtn.addEventListener("click", () => switchLang("GR"));
engBtn.addEventListener("click", () => switchLang("EN"));

locationSelect.addEventListener("change",()=>updateStores(locationSelect.value));
function updateStores(location){
  if(stores[location]){
    storeSelect.innerHTML=`<option value="" disabled selected>${t("selectStore")}</option>`;
    stores[location][currentLang].forEach(store=>{
      const opt=document.createElement("option"); opt.value=store; opt.textContent=store; storeSelect.appendChild(opt);
    });
    storeContainer.classList.add("show");
  } else storeContainer.classList.remove("show");
}

submitBtn.addEventListener("click", ()=>{
  const name=document.getElementById("name").value.trim();
  const day=document.getElementById("day").value.trim();
  const shift=document.getElementById("shift").value;
  const month=document.getElementById("month").value;
  const location=document.getElementById("location").value;
  const store=storeContainer.classList.contains("show")?storeSelect.value:"filled";

  if(name && day && shift && month && location && store){
    push(ref(db,'submissions'), {name, day, shift, month, location, store, timestamp:Date.now(), deviceId: deviceId, status: 'pending'});
    showPopup(t("submitSuccess"), "success");
    document.getElementById("zorbas-form").reset();
    storeContainer.classList.remove("show");
  } else {
    showPopup(t("fillAllFields"), "error");
  }
});

adminBtn.addEventListener("click", ()=>{ 
  adminGui.style.display="flex"; 
  document.getElementById("submit-gui").style.display="none";
});

scheduleBtn.addEventListener("click", ()=>{ 
  scheduleGui.style.display="flex"; 
  document.getElementById("submit-gui").style.display="none";
});

let historyListener = null;

historyBtn.addEventListener("click", () => {
  document.getElementById("submit-gui").style.display="none";
  historyGui.style.display="flex";
  historyContainer.innerHTML = "";
  
  if(historyListener) historyListener();
  
  const displayedKeys = new Set();
  
  historyListener = onValue(ref(db, 'submissions'), snapshot => {
    const data = snapshot.val();
    
    if(data){
      const userSubmissions = [];
      for(let key in data){
        const sub = data[key];
        if(sub.deviceId === deviceId){
          userSubmissions.push({...sub, key});
        }
      }
      
      userSubmissions.sort((a, b) => b.timestamp - a.timestamp);
      
      if(userSubmissions.length === 0){
        historyContainer.innerHTML = `<p style="text-align:center;color:#666;font-size:18px;">${t("noHistory")}</p>`;
        displayedKeys.clear();
        return;
      }
      
      const currentKeys = new Set(userSubmissions.map(s => s.key));
      
      for(let key of displayedKeys){
        if(!currentKeys.has(key)){
          const cardToRemove = document.querySelector(`[data-submission-key="${key}"]`);
          if(cardToRemove){
            cardToRemove.style.animation = "fadeOut 0.3s ease";
            setTimeout(() => cardToRemove.remove(), 300);
          }
          displayedKeys.delete(key);
        }
      }
      
      userSubmissions.forEach((sub, index) => {
        let card = document.querySelector(`[data-submission-key="${sub.key}"]`);
        
        if(!card){
          card = document.createElement("div");
          card.className = "history-card";
          card.setAttribute("data-submission-key", sub.key);
          card.style.animationDelay = `${index * 0.1}s`;
          historyContainer.appendChild(card);
          displayedKeys.add(sub.key);
        }
        
        const status = sub.status || 'pending';
        const statusText = status === 'accepted' ? t("accepted") :
                          status === 'declined' ? t("declined") :
                          (currentLang === "GR" ? "ŒïŒ∫Œ∫œÅŒµŒºŒµŒØ" : "Pending");
        
        const date = new Date(sub.timestamp);
        const dateStr = date.toLocaleDateString() + " " + date.toLocaleTimeString();
        
        card.innerHTML = `
          <p><strong>${currentLang === "GR" ? "ŒåŒΩŒøŒºŒ±:" : "Name:"}</strong> ${sub.name}</p>
          <p><strong>${currentLang === "GR" ? "ŒúŒÆŒΩŒ±œÇ:" : "Month:"}</strong> ${sub.month}</p>
          <p><strong>${currentLang === "GR" ? "ŒóŒºŒ≠œÅŒ±:" : "Day:"}</strong> ${sub.day}</p>
          <p><strong>${currentLang === "GR" ? "ŒíŒ¨œÅŒ¥ŒπŒ±:" : "Shift:"}</strong> ${sub.shift}</p>
          <p><strong>${currentLang === "GR" ? "Œ§ŒøœÄŒøŒ∏ŒµœÉŒØŒ±:" : "Location:"}</strong> ${sub.location}</p>
          <p><strong>${currentLang === "GR" ? "ŒöŒ±œÑŒ¨œÉœÑŒ∑ŒºŒ±:" : "Store:"}</strong> ${sub.store}</p>
          <p><strong>${currentLang === "GR" ? "Œ•œÄŒøŒ≤ŒªŒÆŒ∏Œ∑Œ∫Œµ:" : "Submitted:"}</strong> ${dateStr}</p>
          <span class="history-status ${status}">${statusText}</span>
        `;
        
        const clearBtn = document.createElement("button");
        clearBtn.textContent = currentLang === "GR" ? "ŒîŒπŒ±Œ≥œÅŒ±œÜŒÆ" : "Clear";
        clearBtn.style.cssText = "background:#ff4c4c;color:#fff;padding:8px 16px;border:none;border-radius:6px;cursor:pointer;font-weight:bold;margin-top:15px;transition:all 0.3s ease;";
        clearBtn.addEventListener("mouseover", () => clearBtn.style.transform = "translateY(-2px)");
        clearBtn.addEventListener("mouseout", () => clearBtn.style.transform = "translateY(0)");
        clearBtn.addEventListener("click", () => {
          remove(ref(db, `submissions/${sub.key}`));
          showPopup(currentLang === "GR" ? "Œó œÖœÄŒøŒ≤ŒøŒªŒÆ Œ¥ŒπŒ±Œ≥œÅŒ¨œÜŒ∑Œ∫Œµ" : "Submission cleared", "success");
        });
        
        card.appendChild(clearBtn);
      });
    } else {
      historyContainer.innerHTML = `<p style="text-align:center;color:#666;font-size:18px;">${t("noHistory")}</p>`;
      displayedKeys.clear();
    }
  });
});

backHistoryBtn.addEventListener("click", () => {
  if(historyListener) historyListener();
  historyGui.style.display="none";
  document.getElementById("submit-gui").style.display="block";
});

backAdmin.addEventListener("click", ()=>{ 
  adminGui.style.display="none"; 
  document.getElementById("submit-gui").style.display="block";
});

backSchedule.addEventListener("click", ()=>{ 
  scheduleGui.style.display="none"; 
  document.getElementById("submit-gui").style.display="block";
});

seeSubmissionsBtn.addEventListener("click", ()=>{ 
  adminGui.style.display="none"; 
  locationsGui.style.display="flex"; 
});

locationButtons.forEach(btn=>{
  btn.addEventListener("click", ()=>{
    const loc = btn.dataset.loc;
    locationsGui.style.display="none";
    storeButtonsContainer.innerHTML = "";
    stores[loc][currentLang].forEach((store, index)=>{
      const b=document.createElement("button");
      b.textContent = store;
      b.style.animation = `scaleIn 0.4s ease forwards ${index * 0.05}s`;
      b.style.opacity = "0";
      storeButtonsContainer.appendChild(b);
    });
    storeGui.style.display="flex";
  });
});

backStoreBtn.addEventListener("click", ()=>{ 
  storeGui.style.display="none"; 
  locationsGui.style.display="flex"; 
});

backLocations.addEventListener("click", ()=>{ 
  locationsGui.style.display="none"; 
  adminGui.style.display="flex"; 
});

scheduleLocationButtons.forEach(btn=>{
  btn.addEventListener("click", ()=>{
    const loc = btn.dataset.loc;
    scheduleGui.style.display="none";
    storeButtonsContainerSchedule.innerHTML = "";
    stores[loc][currentLang].forEach((store, index)=>{
      const b=document.createElement("button");
      b.textContent = store;
      b.dataset.location = loc;
      b.style.animation = `scaleIn 0.4s ease forwards ${index * 0.05}s`;
      b.style.opacity = "0";
      storeButtonsContainerSchedule.appendChild(b);
    });
    storeGuiSchedule.style.display="flex";
  });
});

backStoreBtnSchedule.addEventListener("click", ()=>{ 
  storeGuiSchedule.style.display="none"; 
  scheduleGui.style.display="flex"; 
});

resetSubmissionsBtn.addEventListener("click", () => {
  remove(ref(db, 'submissions'));
  showPopup(t("resetSuccess"), "success");
});

seeUsersBtn.addEventListener("click", () => {
  adminGui.style.display = "none";
  devicesGui.style.display = "flex";
  devicesContainer.innerHTML = "";

  onValue(ref(db, 'devices'), snapshot => {
    const data = snapshot.val();
    devicesContainer.innerHTML = "";

    if (data) {
      let index = 0;
      for (let key in data) {
        const d = data[key];
        const box = document.createElement("div");
        box.className = "device-box";
        box.style.cssText = `background:#fff;padding:20px;border-radius:12px;margin-bottom:20px;box-shadow:0 4px 12px rgba(0,0,0,0.2);width:100%;max-width:400px;display:flex;flex-direction:column;align-items:center;gap:15px;animation:scaleIn 0.4s ease forwards;animation-delay:${index * 0.1}s;opacity:0;`;

        const deviceEl = document.createElement("p");
        deviceEl.style.cssText = "font-size:18px;font-weight:bold;text-align:center;margin:0;";
        deviceEl.textContent = `${t('device')}: ${d.type}`;
        box.appendChild(deviceEl);

        const deviceNameEl = document.createElement("p");
        deviceNameEl.style.cssText = "font-size:16px;color:#333;text-align:center;margin:5px 0 0 0;word-break:break-word;font-weight:600;";
        deviceNameEl.textContent = d.name || "Unknown";
        box.appendChild(deviceNameEl);

        const browserEl = document.createElement("p");
        browserEl.style.cssText = "font-size:13px;color:#666;text-align:center;margin:8px 0 0 0;";
        browserEl.innerHTML = `<strong>${t('browser')}:</strong> ${d.browser || 'Unknown'}`;
        box.appendChild(browserEl);

        const osEl = document.createElement("p");
        osEl.style.cssText = "font-size:13px;color:#666;text-align:center;margin:5px 0 0 0;";
        osEl.innerHTML = `<strong>${t('os')}:</strong> ${d.os || 'Unknown'}`;
        box.appendChild(osEl);

        const ipEl = document.createElement("p");
        ipEl.style.cssText = "font-size:13px;color:#E8DA89;text-align:center;margin:5px 0 0 0;font-weight:bold;background:#f5f5f5;padding:6px 12px;border-radius:6px;";
        ipEl.innerHTML = `<strong>${t('ip')}:</strong> ${d.ip || 'Unknown'}`;
        box.appendChild(ipEl);

        const lastActiveEl = document.createElement("p");
        lastActiveEl.style.cssText = "font-size:12px;color:#999;text-align:center;margin:8px 0 0 0;font-style:italic;";
        lastActiveEl.textContent = d.lastActive ? `${t('lastActive')}: ${d.lastActive}` : `${t('lastActive')}: Unknown`;
        box.appendChild(lastActiveEl);

        const spacer = document.createElement("div");
        spacer.style.height = "10px";
        box.appendChild(spacer);

        const buttons = document.createElement("div");
        buttons.style.cssText = "display:flex; gap:20px; justify-content:center;";

        const userBtn = document.createElement("button");
        userBtn.textContent = t("user");
        userBtn.style.cssText = `background:#fff;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-size:16px;transition:all 0.3s ease;`;

        const adminBtn2 = document.createElement("button");
        adminBtn2.textContent = t("admin");
        adminBtn2.style.cssText = `background:#fff;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-size:16px;transition:all 0.3s ease;`;

        function updateRoleUI(selectedRole) {
          if(selectedRole==="user"){
            userBtn.style.fontWeight="bold";
            userBtn.style.textDecoration="underline";
            adminBtn2.style.fontWeight="normal";
            adminBtn2.style.textDecoration="none";
          } else {
            adminBtn2.style.fontWeight="bold";
            adminBtn2.style.textDecoration="underline";
            userBtn.style.fontWeight="normal";
            userBtn.style.textDecoration="none";
          }
        }

        updateRoleUI(d.role);

        userBtn.addEventListener("click", () => {
          set(ref(db, `devices/${key}/role`), "user");
          updateRoleUI("user");
        });

        adminBtn2.addEventListener("click", () => {
          set(ref(db, `devices/${key}/role`), "admin");
          updateRoleUI("admin");
        });

        userBtn.addEventListener("mouseover", () => userBtn.style.transform = "translateY(-2px)");
        userBtn.addEventListener("mouseout", () => userBtn.style.transform = "translateY(0)");
        adminBtn2.addEventListener("mouseover", () => adminBtn2.style.transform = "translateY(-2px)");
        adminBtn2.addEventListener("mouseout", () => adminBtn2.style.transform = "translateY(0)");

        buttons.appendChild(userBtn);
        buttons.appendChild(adminBtn2);
        box.appendChild(buttons);

        devicesContainer.appendChild(box);
        index++;
      }
    } else {
      devicesContainer.innerHTML = `<p>${t("noDevices")}</p>`;
    }
  }, { onlyOnce: true });
});

backDevicesBtn.addEventListener("click", ()=>{
  devicesGui.style.display="none";
  adminGui.style.display="flex";
});

storeButtonsContainer.addEventListener("click",(e)=>{
  if(e.target.tagName==="BUTTON"){
    const storeName = e.target.textContent;
    storeTitle.textContent = `${storeName} Submissions`;
    storeGui.style.display="none";
    storeSubmissionsGui.style.display="flex";

    storeSubmissionsGui.querySelectorAll(".submission-card").forEach(c=>c.remove());

    onValue(ref(db,'submissions'), snapshot=>{
      const data = snapshot.val();
      if(data){
        let cardIndex = 0;
        for(let key in data){
          const sub=data[key];
          if(sub.store===storeName && sub.status === 'pending'){
            const card=document.createElement("div");
            card.className="submission-card";
            card.style.cssText=`background:#fff;padding:20px;margin:10px 0;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.2);width:80%;max-width:500px;animation:slideInLeft 0.4s ease forwards;animation-delay:${cardIndex * 0.1}s;opacity:0;`;
            card.innerHTML=`
              <p><strong>Name:</strong> ${sub.name}</p>
              <p><strong>Month:</strong> ${sub.month}</p>
              <p><strong>Day:</strong> ${sub.day}</p>
              <p><strong>Shift:</strong> ${sub.shift}</p>
            `;

            const acceptBtn = document.createElement("button");
            acceptBtn.textContent = t("acceptSubmission");
            acceptBtn.style.cssText = "background:green;color:#fff;margin-right:10px;padding:8px 16px;border:none;border-radius:6px;cursor:pointer;transition:all 0.3s ease;";
            acceptBtn.addEventListener("mouseover", () => acceptBtn.style.transform = "scale(1.1)");
            acceptBtn.addEventListener("mouseout", () => acceptBtn.style.transform = "scale(1)");
            acceptBtn.addEventListener("click", () => {
              set(ref(db, `submissions/${key}/status`), 'accepted');
              card.style.animation = "fadeOut 0.3s ease";
              setTimeout(() => card.remove(), 300);
              showPopup(t("acceptedSuccess"), "success");
            });

            const declineBtn = document.createElement("button");
            declineBtn.textContent = t("declineSubmission");
            declineBtn.style.cssText = "background:red;color:#fff;padding:8px 16px;border:none;border-radius:6px;cursor:pointer;transition:all 0.3s ease;";
            declineBtn.addEventListener("mouseover", () => declineBtn.style.transform = "scale(1.1)");
            declineBtn.addEventListener("mouseout", () => declineBtn.style.transform = "scale(1)");
            declineBtn.addEventListener("click", () => {
              set(ref(db, `submissions/${key}/status`), 'declined');
              card.style.animation = "fadeOut 0.3s ease";
              setTimeout(() => card.remove(), 300);
              showPopup(t("declinedSuccess"), "success");
            });

            card.appendChild(acceptBtn);
            card.appendChild(declineBtn);
            storeSubmissionsGui.appendChild(card);
            cardIndex++;
          }
        }
      }
    }, { onlyOnce:true });
  }
});

storeButtonsContainerSchedule.addEventListener("click",(e)=>{
  if(e.target.tagName==="BUTTON" && !e.target.classList.contains("back-store-btn")){
    const storeName = e.target.textContent;
    const location = e.target.dataset.location;
    scheduleTitle.textContent = `${storeName} Schedule`;
    storeGuiSchedule.style.display="none";
    scheduleSubmissionsGui.style.display="flex";
    printScheduleBtn.style.display = "block";
    
    loadScheduleFromFirebase(location, storeName);

    scheduleSubmissionsGui.querySelectorAll(".schedule-card").forEach(c=>c.remove());
  }
});

function showPopup(text, type){
  const popup = document.createElement("div");
  popup.className = "popup-notification";
  popup.textContent = text;
  document.body.appendChild(popup);
  
  const popupWidth = popup.offsetWidth;
  
  popup.style.cssText = `
    position: fixed;
    top: -100px;
    left: calc(50% - ${popupWidth / 2 + 10}px);
    width: auto;
    max-width: 300px;
    padding: 15px 25px;
    border-radius: 8px;
    color: black;
    font-weight: bold;
    font-size: 14px;
    z-index: 10000;
    text-align: center;
    transition: top 0.5s ease;
    white-space: nowrap;
    ${type==="success" ? "background-color: #a2f5a2;" : "background-color: #f57c7c;"}
  `;
  
  setTimeout(()=>{
    popup.style.top = "20px";
  }, 50);
  
  setTimeout(()=>{
    popup.style.top = "-100px";
    setTimeout(()=>popup.remove(), 600);
  }, 2500);
}

window.addEventListener("load", () => {
  adminGui.style.display = "none";
  locationsGui.style.display = "none";
  scheduleGui.style.display = "none";
  storeGui.style.display = "none";
  storeGuiSchedule.style.display = "none";
  devicesGui.style.display = "none";
  historyGui.style.display = "none";
  storeSubmissionsGui.style.display = "none";
  scheduleSubmissionsGui.style.display = "none";
  document.getElementById("submit-gui").style.display = "block";
  switchLang("EN"); // Initialize all translations
});
</script>
</body>
</html>